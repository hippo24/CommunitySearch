<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>TFT ì „ì  ìƒì„¸ ì¡°íšŒ</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        padding: 2rem;
        background: #1c1c1e;
        color: #fff;
      }
      input,
      button {
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 8px;
        border: none;
      }
      input {
        width: 300px;
        margin-right: 10px;
      }
      button {
        background-color: #3b82f6;
        color: white;
        cursor: pointer;
      }
      .result {
        margin-top: 2rem;
        padding: 1rem;
        background: #2c2c2e;
        border-radius: 12px;
      }
      .match {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #3a3a3c;
        border-radius: 10px;
      }
      .item-icon {
        width: 24px;
        height: 24px;
        vertical-align: middle;
        margin-right: 4px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” ë¡¤í† ì²´ìŠ¤ ì „ì  ìƒì„¸ ì¡°íšŒ</h1>
    <p>
      ì†Œí™˜ì‚¬ ì´ë¦„ì„ <strong>ë‹‰ë„¤ì„#íƒœê·¸</strong> í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ:
      ê°“ì¡°ì¸#KR1)
    </p>
    <input type="text" id="riotId" placeholder="ì˜ˆ: ê°“ì¡°ì¸#KR1" />
    <button onclick="fetchTFTStats()">ì¡°íšŒí•˜ê¸°</button>
    <div id="result" class="result" style="display: none"></div>

    <script>
      const itemMap = {};
      fetch(
        "https://ddragon.leagueoflegends.com/cdn/14.7.1/data/ko_KR/tft-item.json"
      )
        .then((response) => response.json())
        .then((data) => {
          for (let key in data.data) {
            const item = data.data[key];
            itemMap[item.id] = {
              name: item.name,
              icon: `https://ddragon.leagueoflegends.com/cdn/14.7.1/img/tft-item/${item.image.full}`,
            };
          }
          console.log("ì•„ì´í…œ ë§¤í•‘ ì™„ë£Œ:", itemMap);
        });

      const championMap = {};
      fetch(
        "https://ddragon.leagueoflegends.com/cdn/14.7.1/data/ko_KR/tft-champion.json"
      )
        .then((response) => response.json())
        .then((data) => {
          for (let key in data.data) {
            const champion = data.data[key];
            // champion.id ì˜ˆ: "TFT13_Aatrox" â†’ "Aatrox" ì¶”ì¶œ
            const extractedChampionName = champion.id.replace(/^TFT\d*_/, "");
            // ì¼ë°˜ champion ì´ë¯¸ì§€ë¥¼ ì‚¬ìš© (ì •ì‚¬ê°í˜•ì— ê°€ê¹Œìš´ ì´ë¯¸ì§€)
            championMap[extractedChampionName] = {
              name: champion.name,
              icon: `https://ddragon.leagueoflegends.com/cdn/14.7.1/img/champion/${extractedChampionName}.png`,
            };
          }
          console.log("ì±”í”¼ì–¸ ë§¤í•‘ ì™„ë£Œ:", championMap);
        });

      async function fetchTFTStats() {
        const riotId = document.getElementById("riotId").value;
        const resultDiv = document.getElementById("result");
        resultDiv.style.display = "none";
        resultDiv.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        const apiKey = "";

        if (!riotId.includes("#")) {
          alert("ê²Œì„ì´ë¦„#íƒœê·¸ë¼ì¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const [gameName, tagLine] = riotId.split("#");

        try {
          const accountRes = await fetch(
            `https://asia.api.riotgames.com/riot/account/v1/accounts/by-riot-id/${encodeURIComponent(
              gameName
            )}/${encodeURIComponent(tagLine)}`,
            { headers: { "X-Riot-Token": apiKey } }
          );
          const accountData = await accountRes.json();
          const puuid = accountData.puuid;

          const summonerRes = await fetch(
            `https://kr.api.riotgames.com/tft/summoner/v1/summoners/by-puuid/${puuid}`,
            { headers: { "X-Riot-Token": apiKey } }
          );
          const summonerData = await summonerRes.json();
          const summonerId = summonerData.id;

          const tierRes = await fetch(
            `https://kr.api.riotgames.com/tft/league/v1/entries/by-summoner/${summonerId}`,
            { headers: { "X-Riot-Token": apiKey } }
          );
          const data = await tierRes.json();
          const info = data[0];
          const winRate = (
            (info.wins / (info.wins + info.losses)) *
            100
          ).toFixed(1);

          let html = `
      <h2>${gameName} ë‹˜ì˜ TFT ì „ì </h2>
      <p><strong>ë ˆë²¨:</strong> ${summonerData.summonerLevel}</p>
      <p><strong>í‹°ì–´:</strong> ${info.tier} ${info.rank} (${info.leaguePoints} LP)</p>
      <p><strong>ìŠ¹/íŒ¨:</strong> ${info.wins}ìŠ¹ ${info.losses}íŒ¨</p>
      <p><strong>ìŠ¹ë¥ :</strong> ${winRate}%</p>
      <h3>ğŸ“Š ìµœê·¼ 5ê²½ê¸° ìƒì„¸ ì „ì </h3>
    `;

          const matchIdsRes = await fetch(
            `https://asia.api.riotgames.com/tft/match/v1/matches/by-puuid/${puuid}/ids?count=5`,
            { headers: { "X-Riot-Token": apiKey } }
          );
          const matchIds = await matchIdsRes.json();

          for (const matchId of matchIds) {
            const matchRes = await fetch(
              `https://asia.api.riotgames.com/tft/match/v1/matches/${matchId}`,
              { headers: { "X-Riot-Token": apiKey } }
            );
            const matchData = await matchRes.json();
            const p = matchData.info.participants.find(
              (p) => p.puuid === puuid
            );

            const placement = p.placement ?? "-";
            const level = p.level ?? "-";
            const gold = p.gold_left ?? "-";
            const damage = p.total_damage_to_players ?? "-";
            const date = matchData.info.game_datetime
              ? new Date(matchData.info.game_datetime).toLocaleDateString(
                  "ko-KR"
                )
              : "-";

            const traits = Array.isArray(p.traits)
              ? p.traits
                  .filter((t) => t.tier_current > 0)
                  .map((t) =>
                    t.name
                      .replace(/^TFT\d*_/, "")
                      .replace(/([A-Z])/g, " $1")
                      .trim()
                  )
                  .join(" / ")
              : "ì¡°í•© ì—†ìŒ";

            const units = Array.isArray(p.units)
              ? p.units
                  .map((u) => {
                    const star = "â­".repeat(u.tier);
                    const championName =
                      u.character_id?.replace(/^TFT\d*_/, "") || "ì•Œ ìˆ˜ ì—†ìŒ";
                    // ì±”í”¼ì–¸ ë§¤í•‘ì—ì„œ í•´ë‹¹ ì±”í”¼ì–¸ ë°ì´í„° í™•ì¸
                    const champ = championMap[championName];
                    const championDisplay = champ
                      ? `<img src="${champ.icon}" alt="${champ.name}" title="${champ.name}" width="24" style="vertical-align:middle;margin-right:4px;">`
                      : championName;

                    const items =
                      Array.isArray(u.itemNames) && u.itemNames.length > 0
                        ? u.itemNames
                            .map((name) => {
                              const item = itemMap[name];
                              return item
                                ? `<img src="${item.icon}" alt="${item.name}" title="${item.name}" width="24" style="vertical-align:middle;margin-right:4px;">`
                                : name.replace(/^TFT_Item_|TFT\d+_/g, "");
                            })
                            .join(" ")
                        : ""; // ì•„ì´í…œì´ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ë°˜í™˜

                    return `${championDisplay} ${star}${
                      items ? " â€”&nbsp " + items : ""
                    }`;
                  })
                  .join("<br>")
              : "ì±”í”¼ì–¸ ì •ë³´ ì—†ìŒ";

            html += `
        <div class="match">
          <h4>${placement}ë“± | ë ˆë²¨ ${level} | ê³¨ë“œ ${gold}</h4>
          <p><strong>ì¡°í•©:</strong> ${traits}</p>
          <p><strong>ë”œëŸ‰:</strong> ${damage}</p>
          <p><strong>ì±”í”¼ì–¸:</strong><br>${units}</p>
          <p><strong>ê²½ê¸° ë‚ ì§œ:</strong> ${date}</p>
        </div>`;
          }

          resultDiv.innerHTML = html;
          resultDiv.style.display = "block";
        } catch (e) {
          console.error("ì—ëŸ¬ ë°œìƒ:", e);
          resultDiv.innerHTML = "âš ï¸ ì „ì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          resultDiv.style.display = "block";
        }
      }

      //ì—”í„°ë¡œ ê²€ìƒ‰ ê°€ëŠ¥
      document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById("riotId");

        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            fetchTFTStats();
          }
        });
      });
    </script>
  </body>
</html>
