<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>TFT ì „ì  ìƒì„¸ ì¡°íšŒ</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        padding: 2rem;
        background: #1c1c1e;
        color: #fff;
      }
      input,
      button {
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 8px;
        border: none;
      }
      input {
        width: 300px;
        margin-right: 10px;
      }
      button {
        background-color: #3b82f6;
        color: white;
        cursor: pointer;
      }
      .result {
        margin-top: 2rem;
        padding: 1rem;
        background: #2c2c2e;
        border-radius: 12px;
      }
      .match {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #3a3a3c;
        border-radius: 10px;
      }
      .item-icon {
        width: 24px;
        height: 24px;
        vertical-align: middle;
        margin-right: 4px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” ë¡¤í† ì²´ìŠ¤ ì „ì  ìƒì„¸ ì¡°íšŒ</h1>
    <p>
      ì†Œí™˜ì‚¬ ì´ë¦„ì„ <strong>ê²Œì„ì´ë¦„#íƒœê·¸ë¼ì¸</strong> í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ:
      ê°“ì¡°ì¸#KR1)
    </p>
    <input type="text" id="riotId" placeholder="ì˜ˆ: ê°“ì¡°ì¸#KR1" />
    <button onclick="fetchTFTStats()">ì¡°íšŒí•˜ê¸°</button>
    <div id="result" class="result" style="display: none"></div>

    <script>
      // ìˆ˜ë™ ë§¤í•‘ í…Œì´ë¸” (ì•„ì´í…œ ID: ìˆ«ì)
      // ì•„ì´í…œ í…ìŠ¤íŠ¸ -> ì´ë¯¸ì§€ ì „í™˜ (ììŠµì‹œê°„ì— í•´ë³¼ê²Œìš”.)
      // ì˜ˆì‹œ icon: "https://cdn.metatft.com/cdn-cgi/image/width=80,height=80,format=auto/https://cdn.metatft.com/file/metatft/items/tft_item_rapidfirecannon.png",
      const itemMap = {
        GargoyleStoneplate: {
          name: "ê°€ê³ ì¼ ëŒê°‘ì˜·",
          icon: "https://cdn.metatft.com/items/ê°€ê³ ì¼ëŒê°‘ì˜·.png",
        },
        IonicSpark: {
          name: "ì´ì˜¨ ì¶©ê²©ê¸°",
          icon: "https://cdn.metatft.com/items/ì´ì˜¨ì¶©ê²©ê¸°.png",
        },
        RapidFireCannon: {
          name: "ê³ ì† ì—°ì‚¬í¬",
          icon: "https://cdn.metatft.com/items/ê³ ì†ì—°ì‚¬í¬.png",
        },
        BlueBuff: {
          name: "ë¶‰ì€ ë©êµ´ì •ë ¹",
          icon: "https://cdn.metatft.com/cdn-cgi/image/width=80,height=80,format=auto/https://cdn.metatft.com/file/metatft/items/tft_item_rapidfirecannon.png",
        },
        JeweledGauntlet: {
          name: "ë³´ì„ ê±´í‹€ë¦¿",
          icon: "https://ddragon.leagueoflegends.com/cdn/14.23.1/img/tft-item/TFT_Item_JeweledGauntlet.png",
        },
        ScrapEmblemItem: {
          name: "ê³ ë¬¼ìƒ ìƒì§•",
          icon: "https://cdn.metatft.com/items/ê³ ë¬¼ìƒìƒì§•.png",
        },
        Leviathan: {
          name: "ë¦¬ë°”ì´ì–´ë˜",
          icon: "https://cdn.metatft.com/items/ë¦¬ë°”ì´ì–´ë˜.png",
        },
        SpearOfShojin: {
          name: "ì‡¼ì§„ì˜ ì°½",
          icon: "https://cdn.metatft.com/items/ì‡¼ì§„ì˜ì°½.png",
        },
        // ê³„ì† ì¶”ê°€ í•„ìš”...
      };

      async function fetchTFTStats() {
        const riotId = document.getElementById("riotId").value;
        const resultDiv = document.getElementById("result");
        resultDiv.style.display = "none";
        resultDiv.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        const apiKey = "RGAPI-dd357dd3-702e-4d21-bc26-717827a494e8"; // API Key
        if (!riotId.includes("#")) {
          alert("ê²Œì„ì´ë¦„#íƒœê·¸ë¼ì¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const [gameName, tagLine] = riotId.split("#");

        try {
          const accountRes = await fetch(
            `https://asia.api.riotgames.com/riot/account/v1/accounts/by-riot-id/${encodeURIComponent(
              gameName
            )}/${encodeURIComponent(tagLine)}`,
            {
              headers: { "X-Riot-Token": apiKey },
            }
          );
          const accountData = await accountRes.json();
          const puuid = accountData.puuid;

          const summonerRes = await fetch(
            `https://kr.api.riotgames.com/tft/summoner/v1/summoners/by-puuid/${puuid}`,
            {
              headers: { "X-Riot-Token": apiKey },
            }
          );
          const summonerData = await summonerRes.json();
          const summonerId = summonerData.id;

          const tierRes = await fetch(
            `https://kr.api.riotgames.com/tft/league/v1/entries/by-summoner/${summonerId}`,
            {
              headers: { "X-Riot-Token": apiKey },
            }
          );
          const data = await tierRes.json();
          const info = data[0];
          const winRate = (
            (info.wins / (info.wins + info.losses)) *
            100
          ).toFixed(1);

          let html = `
          <h2>${gameName} ë‹˜ì˜ TFT ì „ì </h2>
          <p><strong>ë ˆë²¨:</strong> ${summonerData.summonerLevel}</p>
          <p><strong>í‹°ì–´:</strong> ${info.tier} ${info.rank} (${info.leaguePoints} LP)</p>
          <p><strong>ìŠ¹/íŒ¨:</strong> ${info.wins}ìŠ¹ ${info.losses}íŒ¨</p>
          <p><strong>ìŠ¹ë¥ :</strong> ${winRate}%</p>
          <h3>ğŸ“Š ìµœê·¼ 5ê²½ê¸° ìƒì„¸ ì „ì </h3>
        `;

          const matchIdsRes = await fetch(
            `https://asia.api.riotgames.com/tft/match/v1/matches/by-puuid/${puuid}/ids?count=5`,
            {
              headers: { "X-Riot-Token": apiKey },
            }
          );
          const matchIds = await matchIdsRes.json();

          for (const matchId of matchIds) {
            const matchRes = await fetch(
              `https://asia.api.riotgames.com/tft/match/v1/matches/${matchId}`,
              {
                headers: { "X-Riot-Token": apiKey },
              }
            );
            const matchData = await matchRes.json();
            const p = matchData.info.participants.find(
              (p) => p.puuid === puuid
            );

            //ìœ ë‹› ì •ë³´ ì½˜ì†” ê²€ì¦
            console.log(p.units);

            const placement = p.placement ?? "-";
            const level = p.level ?? "-";
            const gold = p.gold_left ?? "-";
            const damage = p.total_damage_to_players ?? "-";
            const date = matchData.info.game_datetime
              ? new Date(matchData.info.game_datetime).toLocaleDateString(
                  "ko-KR"
                )
              : "-";

            const traits = Array.isArray(p.traits)
              ? p.traits
                  .filter((t) => t.tier_current > 0)
                  .map((t) =>
                    t.name
                      .replace(/^TFT\d*_/, "")
                      .replace(/([A-Z])/g, " $1")
                      .trim()
                  )
                  .join(" / ")
              : "ì¡°í•© ì—†ìŒ";
            const units = Array.isArray(p.units)
              ? p.units
                  .map((u) => {
                    const star = "â­".repeat(u.tier);

                    // ì±”í”¼ì–¸ ì´ë¦„ ê¹”ë”í•˜ê²Œ (TFT13_ ì œê±°)
                    const championName =
                      u.character_id?.replace(/^TFT\d*_/, "") || "ì•Œ ìˆ˜ ì—†ìŒ";
                    // ì•„ì´í…œ ì´ë¦„ ê¹”ë”í•˜ê²Œ (TFT_Item_ ì œê±°, ë‹¨ì–´ ì‚¬ì´ ë„ì–´ì“°ê¸° ì¶”ê°€)
                    const items =
                      Array.isArray(u.itemNames) && u.itemNames.length > 0
                        ? u.itemNames
                            .map((name) => {
                              const cleanName = name.replace(/^TFT_Item_/, "");
                              const item = itemMap[cleanName];

                              return item
                                ? `<img src="${item.icon}" alt="${item.name}" title="${item.name}" width="24" style="vertical-align:middle;margin-right:4px;">`
                                : cleanName; // ë§¤í•‘ì´ ì—†ëŠ” ê²½ìš° í…ìŠ¤íŠ¸ ì¶œë ¥
                            })
                            .join(" ")
                        : "ì•„ì´í…œ ì—†ìŒ";

                    return `${championName} ${star} â€” ${items}`;
                  })
                  .join("<br>")
              : "ì±”í”¼ì–¸ ì •ë³´ ì—†ìŒ";

            html += `
            <div class="match">
              <h4>${placement}ë“± | ë ˆë²¨ ${level} | ê³¨ë“œ ${gold}</h4>
              <p><strong>ì¡°í•©:</strong> ${traits}</p>
              <p><strong>ë”œëŸ‰:</strong> ${damage}</p>
              <p><strong>ì±”í”¼ì–¸:</strong><br>${units}</p>
              <p><strong>ê²½ê¸° ë‚ ì§œ:</strong> ${date}</p>
            </div>
          `;
          }

          resultDiv.innerHTML = html;
          resultDiv.style.display = "block";
        } catch (e) {
          console.error("ì—ëŸ¬ ë°œìƒ:", e);
          resultDiv.innerHTML = "âš ï¸ ì „ì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          resultDiv.style.display = "block";
        }
      }
      //ì—”í„°ë¡œ ê²€ìƒ‰ ê°€ëŠ¥
      document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById("riotId");

        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            fetchTFTStats();
          }
        });
      });
    </script>
  </body>
</html>
